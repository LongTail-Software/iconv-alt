# tests/ ‚Äî Test Suite

This directory contains all unit tests for iconv-alt using Google Test.

## Test Files

| File | Description |
|------|-------------|
| `smoke.cpp` | Basic build verification |
| `sjis_utf8.cpp` | Main test suite (round-trip, errors, aliases) |
| `auto_rt.cpp` | Auto-generated exhaustive tests (Debug only) |

## Test Cases

### smoke.cpp

| Test | Description |
|------|-------------|
| `main()` | Verify `iconv_open`/`iconv_close` work without crash |

### sjis_utf8.cpp

#### RoundTrip Tests

| Test | Description |
|------|-------------|
| `RoundTrip.Basic` | Full-width hiragana („ÅÇ„ÅÑ„ÅÜ) SJIS ‚Üí UTF-8 ‚Üí SJIS |
| `RoundTrip.HalfWidthKatakana` | Half-width katakana (ÔΩ±ÔΩ≤ÔΩ≥ÔΩ¥ÔΩµ) round-trip |
| `RoundTrip.Ascii` | ASCII text round-trip |
| `RoundTrip.Mixed` | Mixed full-width + half-width + ASCII |

#### Error Tests

| Test | Description | Expected errno |
|------|-------------|----------------|
| `Error.Utf8ToSjis_IllegalSequence` | 4-byte UTF-8 emoji (üòÄ) | `EILSEQ` |
| `Error.Utf8ToSjis_IncompleteSequence` | Truncated 3-byte UTF-8 | `EINVAL` |
| `Error.SjisToUtf8_BufferTooSmall` | Output buffer too small | `E2BIG` |

#### Alias Tests

| Test | Description |
|------|-------------|
| `Alias.CP932ToUtf8` | Use `CP932` as encoding name |
| `Alias.Utf8ToSjis` | Use lowercase `sjis` and `utf8` |
| `Alias.Windows31J` | Use `Windows-31J` as encoding name |
| `Alias.InvalidEncoding` | Verify unknown encoding returns error |

### auto_rt.cpp (Debug only)

| Test | Description |
|------|-------------|
| `SjisRoundTrip.AllPairs` | Test all 7,915 SJIS‚ÜîUnicode mappings |

**Note:** This test is only built in Debug mode due to long compilation time.

## Running Tests

### Using CTest

```bash
# Run all tests
ctest --output-on-failure

# Run specific test
ctest -R RoundTrip

# Run with verbose output
ctest -V
```

### Using Google Test directly

```bash
# Run all tests in sjis_utf8
./tests/sjis_utf8

# Run specific test
./tests/sjis_utf8 --gtest_filter=RoundTrip.Basic

# List all tests
./tests/sjis_utf8 --gtest_list_tests
```

## Adding New Tests

1. Add test function to `sjis_utf8.cpp`:

```cpp
TEST(Category, TestName) {
    // Setup
    const char input[] = "...";
    char output[32]{};
    
    // Execute
    iconv_t cd = iconv_open("UTF-8", "SHIFT_JIS");
    ASSERT_NE((iconv_t)-1, cd);
    // ... conversion ...
    iconv_close(cd);
    
    // Verify
    EXPECT_STREQ(expected, output);
}
```

2. Rebuild and run:

```bash
cmake --build --preset windows-msvc-release-build
ctest --preset windows-msvc-release-test
```

## Code Generation

`auto_rt.cpp` is auto-generated by `scripts/gen_cases.py`:

```bash
python scripts/gen_cases.py
```

This reads `include/sjis_table.h` and generates a test case for each SJIS‚ÜîUnicode mapping.
